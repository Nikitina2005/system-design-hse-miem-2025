# System Design Document
## Дизайн системы Sysop Squad
### 1. Цели и предпосылки (Отсев + Scope Refinement)
#### 1.1. Скоуп проекта  (Scope Refinement)

1. 4 типа пользователей: покупатели, сотрудники магазина, администраторы колл-центра, ИТ-консультанты
2. Подача заявки на устранение неполадок различными пользователями (покупателями, сотрудниками магазина, администраторами колл-центра); распределение заявок по ИТ-консультантам (должно быть не случайным, зависит от того, в каком городе находится пользователь, подавший заявку, свободен подходящий ИТ-консультант или нет, а также от соответсвия заявке компетенций консультанта); система, предлагающая пользователям оценить работу системы и консультанта (оценить по шкале от 1 до 5 скорость и качество обслуживания, все ли понравилось); отслеживание консультантами истории выполненных заявок для каждого клиента (для возможности использовать записи при повторном обращении клиента).
3. Необязательно: если устранение неполадок не требует очного присутствия, распределение может не зависеть от местоположения; улучшение качества обслуживания путем анализа оценок работы консультантов пользователями; ведение базы данных всех заявок с возможностью сгруппировать их по тому, когда была подана заявка, имени клиента или консультанта, сколько времени заняло выполнение заявки; добавление обязательного для заполнения поля с типом неполадки при создании заявки, это бы ускорило обработку и распределение заявок по консультантам.

### 2. Требования и ограничения
#### 2.1 Функциональные требования (ФТ)

| ID  | User Story                                                                                     | Приоритет | Источник (БТ) |
|-----|------------------------------------------------------------------------------------------------|-----------|---------------|
| US1 | Я как пользователь хочу иметь возможность создать заявку на устранение неполадок, чтобы моя проблема была рассмотрена ИТ-консультантом, включая возможность приложить фото или документы. | Highest   | BT1           |
| US2 | Я как пользователь хочу, чтобы заявка направлялась подходящему ИТ-консультанту с учетом географической и временной доступности и квалификации, чтобы проблему устранили быстрее. | Highest   | BT2           |
| US3 | Я как пользователь хочу иметь возможность оценить работу консультанта и системы после решения проблемы, чтобы способствовать улучшению качества обслуживания. | High      | BT3           |
| US4 | Я как сотрудник компании хочу собирать оценки скорости, качества и общего впечатления от работы консультантов, чтобы анализировать их производительность. | Medium    | BT4           |
| US5 | Я как ИТ-консультант хочу видеть историю выполненных работ по заявкам клиента, чтобы учитывать предыдущие обращения при решении новых проблем. | Medium    | BT5           |

#### 2.2 Нефункциональные требования (НФТ)

| ID   | Категория             | Требование                                                                                                                                                  | Приоритет | Источник (БТ) |
|------|-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|---------------|
| NFT1 | Производительность    | Система должна обрабатывать до 10000 пользователей одновременно без снижения времени отклика более чем до 1 секунды для 95% запросов.                      | Highest   | BT1           |
| NFT2 | Масштабируемость      | Система должна позволять масштабирование в географии (подключение новых магазинов по всей территории страны) и количестве пользователей без остановки работы всей системы. | High      | BT2           |
| NFT3 | Отказоустойчивость    | Система должна иметь возможность автоматического переключения на зеркальные серверы в случае сбоя.                                                           | Highest   | BT3           |
| NFT4 | Безопасность          | Все данные должны передаваться и храниться в зашифрованном виде. Обязательная аутентификация и авторизация для всех типов пользователей. Должна соблюдаться информационная безопасность, в том числе защита персональных данных от утечек. | Highest   | BT4           |
| NFT5 | Мониторинг            | Система должна предоставлять централизованный мониторинг и логирование событий, чтобы обеспечить быстрое обнаружение и устранение сбоев, анализ причин ошибок и контроль над системой. | High      | BT5           |
| NFT6 | Регуляторные требования | Система должна соответствовать ФЗ "О персональных данных" (N 152-ФЗ), включая возможность удаления персональных данных клиента по его запросу.            | Highest   | BT6           |
| NFT7 | Совместимость         | Система должна быть совместима с основными браузерами и работать как на ПК, так и на мобильных устройствах.                                                  | Medium    | BT7           |
| NFT8 | Пользовательский опыт | Интерфейсы системы должны быть интуитивно понятными, с откликом интерфейса не более 1 секунды при взаимодействии, особенно при создании заявки и оценке работы ИТ-консультанта. | High      | BT8           |

#### 2.3 Расчет нагрузки

##### Трафик

Оценка числа пользователей системы:

Покупатели: 5 миллионов пользователей системы в год, 400 тысяч активных в месяц, до 20 тысяч в день

Сотрудники магазинов: около 5000

Администраторы колл-центров: около 2000

ИТ-консультанты: около 2000

Средняя активность: 30000 заявок в систему в день, максимум достигает 50000 в день

Максимальная нагрузка: 50000 заявок в день, следовательно, приблизительно 1 заявка в 2 секунды

Рассчитаем RPS (request per second), возможные операции в системе: создание заявки, распределение заявки ИТ-консультанту, оценка работы клиентом, просмотр истории заявок клиента, обновление статуса заявки.

Следовательно, можно оценить верхнюю границу трафика как 5 RPS в самом загруженном состоянии системы.

##### БД

Пусть на одну заявку приходится максимум 1 MB памяти в БД с учетом возможных прикрепленных документов к заявке (например, фотографий неполадок).

Если заявок в день максимум 50000, значит, заявки за один день максимум занимают около 50 GB, за один месяц - 1.5 миллионов, это 1.5 TB, а за один год - 18 миллионов и 18 TB.

Историю заявок за прошлые года можно хранить в сжатом виде, так как к ней нет необходимости получать быстрый доступ, и в то же время важно уменьшить занимаемую данными память.

#### 2.4 Ограничения

##### 2.4.1 Список ограничений (может дополняться)

1. Бизнес-модель: B2C, так как Sysop Squad ориентирована на частных потребителей.

2. Основные бизнес-метрики: DAU/MAU, Retention, время от подачи заявки до начала её обработки консультантом, среднее время обработки заявки, средняя оценка качества обслуживания.

Масштабирование: увеличение числа пользователей (клиентов и сотрудников), территориальное масштабирование.

3. География пользователей: по всей России.

Нужно учитывать территориальное распределение ИТ-консультантов и пользователей.

4. Специфика домена: e-commerce

Большое количество пользователей, важна скорость отклика и простота интерфейса, важны оценки клиентов, возможны частые подачи заявок клиентом после покупок электроники.

5. Тип устройств: мобильные устройства, персональные компьютеры.

Важна кроссплатформенность системы.

6. Этап развития: MVP

Важен сбор отзывов пользователей в реальном времени для непрерывного улучшения.

7. Тип развертывания: Cloud

Позволяет не обеспечивать серверную инфраструктуру для каждого региона, обеспечивает масштабирование при росте числа пользователей, проще интеграция с другими сервисами (CRM, уведомления).

8. Время разработки: 6 месяцев

Время на разработку ограничено, так как это MVP.

9. Бюджет на технологии:

Бюджет также ограничен, предполагается использование уже существующих сервисов и решений, в том числе open-source. В приоритете обеспечение защиты персональных данных клиентов.

10. Технологии (тех. компас компании): PostgreSQL, Python, Kafka, React, Docker, Kubernetes.

Переиспользование существующих механизмов авторизации и аутентификации, мониторинга, имеющейся базы пользователей.

11. Существующие сервисы: корпоративная CRM, система авторизации, система учёта обращений для сотрудников (helpdesk).

12. Бюджет на железо: ограничен, желательно без масштабной покупки серверов

Приоритет отдается облачным технологиям и автоматическому масштабированию по нагрузке.

13. SLA (доступность, производительность):

Система должна быть доступна в часы работы магазинов и колл-центров, в остальное время могут быть выделены фиксированные часы для проведения технических работ.

Время отклика интерфейса: не более 1 секунды для 95% запросов, не более 5 секунд на тяжелые запросы, например, просмотр истории заявок клиента.

14. Регуляторные ограничения: соблюдение федерального закона "О персональных данных" от 27.07.2006 N 152-ФЗ.

Необходимо наличие возможности удаления персональных данных по запросу пользователя.

15. Интеграции: API для уведомлений по статусу заявки (SMS, email).

16. Санкции и импортозамещение: использование отечественных платформ, например, VK Cloud или Yandex Cloud.

### 3. Проектирование
#### 3.1 High Level Design
##### 3.1.1 Интеграции

| Сервисы                                               | Тип интеграции | Реализация                   | Технологии | Обоснование                                                                                   |
|-------------------------------------------------------|----------------|------------------------------|------------|----------------------------------------------------------------------------------------------|
| Сервис авторизации и остальные сервисы                | Синхронная     | API-шлюз (API Gateway)       | HTTP, JWT  | Необходимо проверять права и идентификацию пользователя при каждом запросе.                  |
| Сервис управления заявками и сервис назначения заявок | Синхронная     | Прямое взаимодействие (P2P)  | gRPC       | Требуется мгновенно назначать консультанта при создании новой заявки.                        |
| Сервис назначения заявок и сервис управления пользователями | Синхронная     | Прямое взаимодействие (P2P)  | gRPC       | Нужно оперативно получать данные консультантов (геолокация, квалификация, занятость).        |
| Сервис управления заявками и сервис уведомлений       | Асинхронная    | Через брокер сообщений       | Kafka      | Не критично моментально доставить уведомление, важно не потерять сообщение.                   |
| Сервис назначения заявок и сервис уведомлений         | Асинхронная    | Через брокер сообщений       | Kafka      | Консультант должен получать уведомление о новой заявке, но не блокировать бизнес-логику.     |
| Сервис управления заявками и сервис оценки и отзывов  | Синхронная     | Прямое взаимодействие (P2P)  | gRPC       | Для возможности оставить отзыв нужно сразу получить данные о завершённой заявке.              |
| Сервис управления пользователями и сервис оценки      | Синхронная     | Прямое взаимодействие (P2P)  | gRPC       | Требуется синхронизировать отзывы с профилями консультантов.                                 |
| Сервис оценки и отзывов и сервис уведомлений          | Асинхронная    | Через брокер сообщений       | Kafka      | Уведомление о новой оценке должно быть доставлено консультанту, но не обязательно мгновенно. |
| Все сервисы и сервис мониторинга и логирования       | Асинхронная    | Через брокер сообщений       | Kafka      | Логи и метрики собираются фоново для последующего анализа и диагностики.                     |

##### 3.1.2 Данные

Сценарии и выбор БД

| Сценарий                           | Выбранная БД              | Обоснование                                                                                         |
|------------------------------------|---------------------------|-----------------------------------------------------------------------------------------------------|
| Авторизация и аутентификация       | PostgreSQL + Redis         | PostgreSQL — для хранения пользователей и прав доступа с поддержкой связей и транзакций. Redis — для хранения сессий авторизации и токенов. |
| Управление заявками                | PostgreSQL                | Хранение заявок, пользователей и консультантов, связей между ними. Требуются транзакции.            |
| Хранение вложений (в заявках)      | MongoDB                   | Эффективно хранит большие объёмы данных в формате документов, легко масштабируется.                |
| Назначение заявок консультантам    | PostgreSQL + Redis         | PostgreSQL — для хранения заявок и связей, Redis — для кэширования доступных консультантов и очередей заявок. |
| История выполненных заявок         | PostgreSQL                | Для хранения истории обращений и поддержки удобного поиска и аналитики.                            |
| Оценки и отзывы                    | PostgreSQL + ClickHouse    | PostgreSQL — для хранения отзывов и связей между сущностями. ClickHouse — для аналитики больших объемов данных. |
| Уведомления                        | Redis                     | Используется Pub/Sub для отправки уведомлений в реальном времени.                                   |
| Мониторинг и логирование           | ClickHouse                | ClickHouse — эффективное хранение и быстрый анализ больших объёмов логов и метрик.                  |
| Кэширование данных                 | Redis                     | Redis — для быстрого доступа к часто используемым данным, снижение нагрузки на основные БД.        |

Репликация

В PostgreSQL используется как синхронная репликация для более важных данных, например, заявок, пользователей и т.д., так и асинхронная для второстепенных, например, для истории заявок. Репликация необходима здесь для защиты от потери данных и возможности обеспечить постоянный доступ к БД.

В MongoDB, Redis и ClickHouse репликация тоже нужна при реализации данной системы для обеспечения отказоустойчивости. Здесь при отказе какого-то узла должно автоматически происходить переключение на другой узел.

Шардинг

В PostgreSQL используется горизонтальное разбиение по геолокации клиентов и консультантов. В PostgreSQL нет поддержки встроенного шардинга, поэтому можно использовать Citus.

В MongoDB шардинг нужен для равномерного распределения больших объемов файлов по узлам, тоже горизонтальное разбиение. Здесь есть встроенная поддержка шардинга.

С Redis и ClickHouse аналогично пункту 2, только вместо файлов соответствующие данные, тоже горизонтальное разбиение.

##### 3.1.3 Концептуальная схема

Компоненты-сервисы:
1. Сервис авторизации и аутентификации - отличается для консультантов и клиентов;
2. Сервис управления заявками - отвечает за создание заявок, загрузку файлов, чтобы приложить их к заявке, хранит историю заявок;
3. Сервис управления пользователями (как клиентами, так и консультантами) - для консультантов хранит их геолокацию, часы работы, свободен ли консультант, его квалификацию, для клиента - просто геолокацию;
4. Сервис назначения заявок консультантам - выполняет распределение заявок по консультантам с учетом географической и временной доступности консультанта, а также его квалификации;
5. Сервис оценки и отзывов - здесь название говорит само за себя;
6. Сервис уведомлений - уведомления клиенту/консультанту о том, что заявка создана/назначена консультанту/выполняется на определенном этапе/завершена;
7. Сервис мониторинга и логирования - для контроля над системой.

#### 3.2 Deep Dive
##### 3.2.1 Ключевые компоненты/подходы и их назначение

Обязательные компоненты (MUST)

Репликации и шардирования здесь нет, так как это скорее подходы и они были описаны в предыдущем домашнем задании, хотя в данной системе они обязательны.

| Компонент                   | Обоснование                                                                                                                           | Реализация                                |
|-----------------------------|---------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
| **Кэш (Redis)**             | Для хранения сессий пользователей, доступных консультантов, очередей заявок, важно для производительности.                        | Redis Cluster                             |
| **CI/CD**                   | Автоматизация развертывания — критично для стабильности обновлений системы с множеством сервисов.                                     | GitHub CI    |
| **IdP (Identity Provider)** | Единый механизм аутентификации всех пользователей (покупатели, сотрудники магазинов, консультанты). | Keycloak                                  |
| **API Gateway**             | Нужно для управления API, авторизации и аутентификации, удобства масштабирования.                                                             | Tyk                            |
| **WAF**                     | Необходим для защиты API-запросов с авторизацией и вложениями. Минимизирует риски атак на уязвимости API.                             | Cloudflare WAF с настройкой под API       |
| **Load Balancer**           | Горизонтальное масштабирование сервисов (управление заявками, оценками, авторизацией). Обеспечивает отказоустойчивость.               | NGINX (L7) + Yandex Load Balancer |
| **Резервное копирование**   | Гарантирует восстановление заявок, истории обращений, оценок и других данных, критично для соблюдения требований 152-ФЗ.                             | Снэпшоты S3 + WAL-G, так как он может использоваться для бэкапа как для PostgreSQL, так и для MongoDB        |
| **Observability**           | Необходимо для отслеживания логов и метрик, а также для диагностики проблем, например, задержки назначения консультанта или ошибки при создании заявки.   | Prometheus + Grafana|
| **GeoDNS**            | Важно, так как система изначально рассчитана на пользователей с геолокацией по всей стране. | Yandex DNS     |

Рекомендуемые компоненты (SHOULD)

| Компонент             | Обоснование                                                                                          | Реализация                |
|-----------------------|------------------------------------------------------------------------------------------------------|---------------------------|
| **CDN**               | Для вложений (фото, других файлов) минимизация задержек при загрузке для пользователей по всей стране. | S3 + Cloudflare       |
| **Service Mesh**      | При росте числа сервисов потребуется управление взаимодействием между узлами.      | Istio                     |
| **Circuit Breaker, Retry, Rate Limiting**      | При расширении системы и росте нагрузки на нее нужно будет поддерживать отказоустойчивость системы.      | Istio                     |
| **Feature Flags**     | Для безопасного включения новых функций (например, новых типов заявок или нового UI).                | LaunchDarkly                    |
